<script>
plotBtn.addEventListener("click", async ()=>{
  errEl.style.display = "none";
  try{
    const parsed = parsePromptItems(promptEl.value); // [{label,address,city}]
    const fromScenes = scenesEl.value
      .split(/\n|,/).map(s=>s.trim()).filter(Boolean)
      .map(a => ({ label:a, address:a, city:null }));

    const lines = [...parsed, ...fromScenes];

    const results = [];
    for (const entry of lines){
      // Already lat,lon?
      const m = entry.address.match(/(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)/);
      if (m){
        results.push({ id:crypto.randomUUID(), name:entry.label, lat:parseFloat(m[1]), lon:parseFloat(m[2]) });
      } else {
        const g = await geocodeRobust(entry.address, entry.city, entry.label);
        results.push({ id:crypto.randomUUID(), name:entry.label, lat:g.lat, lon:g.lon });
      }
    }

    waypoints = results;

    // update static sources and list immediately
    syncUIAndMap();

    // run the 3D animation (respects your 3D toggle)
    await animateRoute(map, waypoints, { pitch3d: is3D });

  }catch(ex){
    errEl.textContent = ex && ex.message ? ex.message : "Failed to geocode.";
    errEl.style.display = "block";
  }
});
</script>
